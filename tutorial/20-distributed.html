<!DOCTYPE html>
<html>

  <head>
  

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Distributed Deployment | BRAIN-IoT</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Distributed Deployment" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Summary" />
<meta property="og:description" content="Summary" />
<meta property="og:site_name" content="BRAIN-IoT" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-11T13:53:40+00:00" />
<script type="application/ld+json">
{"description":"Summary","@type":"BlogPosting","headline":"Distributed Deployment","dateModified":"2021-02-11T13:53:40+00:00","datePublished":"2021-02-11T13:53:40+00:00","url":"/brain-iot-tutorials/tutorial/20-distributed.html","mainEntityOfPage":{"@type":"WebPage","@id":"/brain-iot-tutorials/tutorial/20-distributed.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" />
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/vbnet.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>

  <!-- Overridden theme -->
  <link rel="stylesheet" href="/brain-iot-tutorials/css/main.css" />

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous" />

  <!-- Optional theme -->
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous" /> -->
  <!-- Bootstrap override -->
  <link rel="stylesheet" href="/brain-iot-tutorials/css/bootstrap-override.css" />

  <link rel="alternate" type="application/rss+xml" title="BRAIN-IoT" href="/feed.xml" />

  <link rel="shortcut icon" href="/brain-iot-tutorials/img/favicon.ico" />
</head>


  <body>
    

    <div class="container">

      <header class="site-header">


<a class="site-title" href="/brain-iot-tutorials/"><img src="/brain-iot-tutorials/img/BRAIN-IoT_Logo.png" alt="BRAIN-IoT" height="75" width="154" /></a>

    <nav class="site-nav">
      <img class="menu-icon" src="/brain-iot-tutorials/img/gi.svg" />
      
      <div class="trigger">
      	<!--<a class="page-link" href="/brain-iot-tutorials/">Welcome</a>-->
        <!-- get current page title and "collection" to figure out which nav
             link should be "active" -->
        
        
        
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
                
                  <a class="page-link" href="/brain-iot-tutorials/tutorial/">Tutorials</a>
                
              
            
          
        
        </div>
      </div>

    </nav>

</header>


      <div class="page-content">
        <!--div class="wrapper"-->
          <div class="container-fluid">

<div class="row-fluid">
    <!--Nav Bar -->
    <nav class="col-xs-0 col-md-3 bs-docs-sidebar">
    <ul id="sidebar" class="nav nav-stacked fixed">
        <!-- Find the h2 group and any h3 subgroups -->
        

        
          

          
            
            
            
            
            <li>
              <a href="#summary">Summary</a>

              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#setup">Setup</a>

              
                <ul class="nav nav-stacked">
                  

                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#brain-iot-repos">brain-iot-repos</a>
                    </li>
                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#system-document">System Document</a>
                    </li>
                  

                </ul>
              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#deploy-on-fabric">Deploy on Fabric</a>

              
                <ul class="nav nav-stacked">
                  

                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#fabric-ui">Fabric UI</a>
                    </li>
                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#set-labels">Set Labels</a>
                    </li>
                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#deploy-system">Deploy System</a>
                    </li>
                  

                </ul>
              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#brain-iot-ui">BRAIN-IoT UI</a>

              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#security-light-example">Security Light Example</a>

              
                <ul class="nav nav-stacked">
                  

                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#discover-http-port">Discover HTTP port</a>
                    </li>
                  

                </ul>
              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#undeploy">Undeploy</a>

              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#end">End</a>

              

            </li>
          

        
    </ul>
</nav>


    <!--Main Content -->
    <div class="col-xs-12 col-md-9">
      <!--<div class="post">-->

        <article class="post-content">


          <a class=nav-prev href="10-developer.html" >Prev</a>
          <a class=nav-next href="30-fabric-cloud.html" >Next</a>
          <hr />
          <br />
          <h1>Distributed Deployment</h1>
          <br />

          <p>
</p>

          <p></p>

          <h2 id="summary">Summary</h2>

<p>In this tutorial we’ll deploy the BRAIN-IoT core services in multiple containers using the Paremus Service Fabric.</p>

<p>The Fabric manages multiple remote containers  and can deploy OSGi artifacts to them.</p>

<p class="note">This tutorial assumes a Fabric is already running and we know its admin URL. 
The <a href="30-fabric-cloud.html">Create Fabric in Cloud</a> and  <a href="35-fabric-onpremise.html">Create Fabric on-premise</a> tutorials cover creating and starting a Fabric.</p>

<h2 id="setup">Setup</h2>

<p>An HTTP server is required to serve the BRAIN-IoT artefacts to be deployed to the Fabric.</p>

<h3 id="brain-iot-repos">brain-iot-repos</h3>

<p>We first need to copy the BRAIN-IoT core repositories to the HTTP server. These contain the Event Bus, Behaviour Management Service, BRAIN-IoT User Interface and their dependencies.</p>

<p>You can either clone and build the <a href="https://git.repository-pert.ismb.it/BRAIN-IoT/fabric-deployment" target="_blank">fabric-deployment</a> project from GitLab or download the latest <a href="https://nexus.repository-pert.ismb.it/repository/maven-snapshots/com/paremus/brain/iot/brain-iot-repos/0.0.1-SNAPSHOT/brain-iot-repos-0.0.1-20200720.125205-11.zip">brain-iot-repos.zip</a> from Nexus:</p>

<div class="language-plaintext shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -u someuser -O https://nexus.repository-pert.ismb.it/repository/maven-snapshots/com/paremus/brain/iot/brain-iot-repos/0.0.1-SNAPSHOT/brain-iot-repos-0.0.1-20200720.125205-11.zip
Enter host password for user 'someuser':
</code></pre></div></div>

<p>If you choose to build the <code class="language-plaintext highlighter-rouge">fabric-deployment</code> project:</p>

<div class="language-plaintext shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone git@git.repository-pert.ismb.it:BRAIN-IoT/fabric-deployment.git
$ cd fabric-deployment/fabric-deploy-repos
$ mvn package
</code></pre></div></div>

<p class="note">Created zip is <code class="language-plaintext highlighter-rouge">brain-iot-repos/target/brain-iot-repos-0.0.1-SNAPSHOT.zip</code></p>

<p>Unzip <code class="language-plaintext highlighter-rouge">brain-iot-repos.zip</code> in the root of the HTTP server (it unpacks into directory <code class="language-plaintext highlighter-rouge">brain-iot-repos</code>), for example:</p>

<div class="language-plaintext shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>webserver $ sudo unzip -d /usr/share/nginx/html /tmp/brain-iot-repos-0.0.1-SNAPSHOT.zip
</code></pre></div></div>

<h3 id="system-document">System Document</h3>

<p>The Fabric uses a <code class="language-plaintext highlighter-rouge">system document</code> to control deployment. Its purpose is similar to the <code class="language-plaintext highlighter-rouge">app.bndrun</code> from the <code class="language-plaintext highlighter-rouge">quickstart</code> tutorial.</p>

<p>A <code class="language-plaintext highlighter-rouge">system document</code> defines multiple <code class="language-plaintext highlighter-rouge">system.part</code>, each of which is deployed to an isolated OSGi framework in a remote OSGi container (or “fibre”).</p>

<p>The key parts of a system document are:</p>

<h4 id="repopath">repopath</h4>

<p><code class="language-plaintext highlighter-rouge">repopath</code>: is a list of relative or absolute URLs to repository indexes.</p>

<p>It is similar to the <code class="language-plaintext highlighter-rouge">-standalone: target/index.xml</code> directive in <code class="language-plaintext highlighter-rouge">bndrun</code>.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;system</span> <span class="na">xmlns=</span><span class="s">"http://schema.paremus.com/sf/1.2"</span>
        <span class="na">name=</span><span class="s">"Brain-IoT-Smart-Security-Light-Fabric"</span>
        <span class="na">version=</span><span class="s">"1.0.0"</span>
        <span class="na">repopath=</span><span class="s">"brain-iot-repos/core/index.xml,brain-iot-repos/ui/index.xml"</span>
        <span class="na">boundary=</span><span class="s">"fabric"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<h4 id="systempart">system.part</h4>

<p><code class="language-plaintext highlighter-rouge">system.part</code> contains all other elements:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;system.part</span> <span class="na">name=</span><span class="s">"Core"</span><span class="nt">&gt;</span>
 ...
 <span class="nt">&lt;/system.part&gt;</span>
 
 <span class="nt">&lt;system.part</span> <span class="na">name=</span><span class="s">"UI"</span><span class="nt">&gt;</span>
 ...
 <span class="nt">&lt;/system.part&gt;</span>
</code></pre></div></div>

<h4 id="config">config</h4>

<p><code class="language-plaintext highlighter-rouge">config</code> is used to configure <code class="language-plaintext highlighter-rouge">system.part</code> using ConfigAdmin.</p>

<p>Here is the config for the UI, note the setting of port=8888:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;config</span> <span class="na">pid=</span><span class="s">"org.apache.felix.http"</span> <span class="na">factory=</span><span class="s">"true"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"org.osgi.service.http.port"</span> <span class="na">value=</span><span class="s">"8888"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"org.eclipse.jetty.servlet.SessionCookie"</span>
                <span class="na">value=</span><span class="s">"Paremus-SessionId"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/config&gt;</span>
</code></pre></div></div>

<p>and here is the config to set the security light marketplace indexes on the Behaviour Management Service:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;config</span> <span class="na">pid=</span><span class="s">"eu.brain.iot.BehaviourManagementService"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- brain-iot marketplace indexes (comma separated) --&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"indexes"</span>
                <span class="na">value=</span><span class="s">"https://nexus.repository-pert.ismb.it/repository/marketplaces/com.paremus.brain.iot.marketplace/security-light-marketplace/0.0.1-SNAPSHOT/index.xml"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/config&gt;</span>
</code></pre></div></div>

<p class="note">Note this is the <em>only</em> part of the <code class="language-plaintext highlighter-rouge">system document</code> that is specific to the security light. If we omit this setting, the <code class="language-plaintext highlighter-rouge">system document</code> would be generic and we could configure the marketplace indexes for the Behaviour Management Service (BMS) in the BRAIN-IoT UI as shown in The <a href="05-quickstart.html">Quick Start</a> tutorial.</p>

<h4 id="systempartelement">system.part.element</h4>

<p><code class="language-plaintext highlighter-rouge">system.part.element</code> is similar to <code class="language-plaintext highlighter-rouge">-runrequires</code> in <code class="language-plaintext highlighter-rouge">bndrun</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c">&lt;!-- The core BRAIN-IoT fabric requirements --&gt;</span>
    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"com.paremus.brain.iot.eventing.impl"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<h4 id="replicationhandler">replication.handler</h4>

<p>A replication handler has no equivalent in <code class="language-plaintext highlighter-rouge">bndrun</code>. It is used to replicate a <code class="language-plaintext highlighter-rouge">system.part</code> across multiple remote containers/nodes.</p>

<p>If not specified, for example in the <code class="language-plaintext highlighter-rouge">UI</code>, then the <code class="language-plaintext highlighter-rouge">system.part</code> is only deployed to a single node.</p>

<p>The BRAIN-IoT Core (EventBus etc) needs to be deployed to all nodes in the fabric, so it specifies this <code class="language-plaintext highlighter-rouge">replication.handler</code> :</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c">&lt;!-- replicate Core system.part to all nodes --&gt;</span>
    <span class="nt">&lt;replication.handler</span> <span class="na">name=</span><span class="s">"scale"</span> <span class="na">type=</span><span class="s">"scalable"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"scaleFactor"</span> <span class="na">value=</span><span class="s">"1.0"</span> <span class="na">type=</span><span class="s">"float"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"minimum"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="na">type=</span><span class="s">"integer"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/replication.handler&gt;</span>
</code></pre></div></div>

<h4 id="contract">contract</h4>

<p><code class="language-plaintext highlighter-rouge">contract</code> is used to target deployment. Here the UI <code class="language-plaintext highlighter-rouge">system.part</code> will only be deployed to a node containing the <code class="language-plaintext highlighter-rouge">UI</code> feature:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c">&lt;!-- deploy to node with label UI --&gt;</span>
    <span class="nt">&lt;contract</span> <span class="na">features=</span><span class="s">"(UI=*)"</span> <span class="na">cancelationCost=</span><span class="s">"-1"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<h4 id="brain-iot-systemxml">brain-iot-system.xml</h4>

<p>Here’s the full <code class="language-plaintext highlighter-rouge">system document</code> <code class="language-plaintext highlighter-rouge">brain-iot-system.xml</code> for the Security Light system. It needs to be installed at the root of the HTTP server (so that the <code class="language-plaintext highlighter-rouge">repopath</code> resolves to the <code class="language-plaintext highlighter-rouge">brain-iot-repos</code> folder we’ve just unpacked).</p>

<p>
  <a class="btn btn-primary" data-toggle="collapse" href="#system" aria-expanded="false" aria-controls="system">
    brain-iot-system.xml
  </a>
</p>
<div class="collapse" id="system">
  <div class="card card-block">


<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;system</span> <span class="na">xmlns=</span><span class="s">"http://schema.paremus.com/sf/1.2"</span>
        <span class="na">name=</span><span class="s">"Brain-IoT-Smart-Security-Light-Fabric"</span>
        <span class="na">version=</span><span class="s">"1.0.0"</span>
        <span class="na">repopath=</span><span class="s">"brain-iot-repos/core/index.xml,brain-iot-repos/ui/index.xml"</span>
        <span class="na">boundary=</span><span class="s">"fabric"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;system.part</span> <span class="na">name=</span><span class="s">"Core"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;config</span> <span class="na">pid=</span><span class="s">"eu.brain.iot.BehaviourManagementService"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- brain-iot marketplace indexes (comma separated) --&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"indexes"</span>
                <span class="na">value=</span><span class="s">"https://nexus.repository-pert.ismb.it/repository/marketplaces/com.paremus.brain.iot.marketplace/security-light-marketplace/0.0.1-SNAPSHOT/index.xml"</span> <span class="nt">/&gt;</span>
      
      <span class="c">&lt;!-- BND connection settings, used if the marketplace requires authentication and required on all nodes running as fibres--&gt;</span>
      
      <span class="c">&lt;!-- 
         This version uses environment variables which must be set
         when launching the Paremus Service Fabric fibres
         MARKET_PLACE_USER - the user name
         MARKET_PLACE_PASSWORD - the password
       --&gt;</span>
      <span class="c">&lt;!-- &lt;property name="connection.settings"
                value="server;id=https://nexus.repository-pert.ismb.it;username=${envcfg#MARKET_PLACE_USER};password=${envcfg#MARKET_PLACE_PASSWORD}"/&gt;  --&gt;</span>
      
      <span class="c">&lt;!-- This version defaults to $HOME/.m2/settings.xml --&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"connection.settings"</span>
                <span class="na">value=</span><span class="s">""</span><span class="nt">/&gt;</span>

      <span class="c">&lt;!-- This version sets a different file location --&gt;</span>
      <span class="c">&lt;!-- &lt;property name="connection.settings"
                value="/opt/fabric/brain-iot/settings.xml"/&gt;  --&gt;</span>
    <span class="nt">&lt;/config&gt;</span>

    <span class="c">&lt;!-- replicate Core system.part to all nodes --&gt;</span>
    <span class="nt">&lt;replication.handler</span> <span class="na">name=</span><span class="s">"scale"</span> <span class="na">type=</span><span class="s">"scalable"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"scaleFactor"</span> <span class="na">value=</span><span class="s">"1.0"</span> <span class="na">type=</span><span class="s">"float"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"minimum"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="na">type=</span><span class="s">"integer"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/replication.handler&gt;</span>

    <span class="c">&lt;!-- The core BRAIN-IoT fabric requirements --&gt;</span>
    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"com.paremus.brain.iot.eventing.impl"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"com.paremus.brain.iot.management.impl"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"com.paremus.brain.iot.installer.impl"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"com.paremus.brain.iot.resolver.impl"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"com.paremus.brain.iot.message.integrity.insecure.impl"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"com.paremus.ui.metaconfig"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/system.part&gt;</span>

  <span class="nt">&lt;system.part</span> <span class="na">name=</span><span class="s">"UI"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;launch.properties&gt;</span>
      <span class="c">&lt;!-- prevent Jetty from starting until its config is loaded --&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"org.osgi.service.http.port"</span> <span class="na">value=</span><span class="s">"-1"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/launch.properties&gt;</span>

    <span class="c">&lt;!-- configure jetty for UI --&gt;</span>
    <span class="nt">&lt;config</span> <span class="na">pid=</span><span class="s">"org.apache.felix.http"</span> <span class="na">factory=</span><span class="s">"true"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"org.osgi.service.http.port"</span> <span class="na">value=</span><span class="s">"8888"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"org.eclipse.jetty.servlet.SessionCookie"</span>
                <span class="na">value=</span><span class="s">"Paremus-SessionId"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/config&gt;</span>

    <span class="c">&lt;!-- deploy to node with label UI --&gt;</span>
    <span class="nt">&lt;contract</span> <span class="na">features=</span><span class="s">"(UI=*)"</span> <span class="na">cancelationCost=</span><span class="s">"-1"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"com.paremus.brain.iot.ui.rest.app"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"com.paremus.ui.rest.config"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"com.paremus.ui.client"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"org.apache.aries.jax.rs.shiro.authz"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"org.apache.aries.jax.rs.jackson"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;system.part.element</span> <span class="na">name=</span><span class="s">"com.fasterxml.jackson.jaxrs.jackson-jaxrs-json-provider"</span>
                         <span class="na">category=</span><span class="s">"osgi.bundle"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/system.part&gt;</span>

<span class="nt">&lt;/system&gt;</span></code></pre></figure>

</div>
</div>

<p>You can either copy/paste it from here or clone the <a href="https://git.repository-pert.ismb.it/BRAIN-IoT/fabric-systems" target="_blank">fabric-systems</a> project from GitLab (its path is <code class="language-plaintext highlighter-rouge">security-light-fabric/src/main/resources/brain-iot-system.xml</code>).</p>

<p>To confirm that setup is correct, browse to <a href="http://10.8.0.98/brain-iot-system.xml" target="_blank">http://10.8.0.98/brain-iot-system.xml</a>, replacing 10.8.0.98 with the ip-address of your HTTP server.</p>

<h2 id="deploy-on-fabric">Deploy on Fabric</h2>

<p>Now we’ve completed the setup we can deploy the Security Light Example to the Fabric.</p>

<h3 id="fabric-ui">Fabric UI</h3>

<p>Browse to the Admin URL for your Fabric, for example: <a href="https://10.8.0.94:9106/" target="_blank">https://10.8.0.94:9106/</a></p>

<p class="warning">Note: the Fabric doesn’t have a security certificate, so you’ll need to dismiss browser warnings about it being an unsecure site.</p>

<p><img src="img/fabric-login.png" alt="Fabric Login" height="700px" /></p>

<p>Login with username <code class="language-plaintext highlighter-rouge">AdminUser</code> and password <code class="language-plaintext highlighter-rouge">AdminUser</code>, and then click the checkbox to show <code class="language-plaintext highlighter-rouge">Fibre Names</code>:</p>

<p><img src="img/fabric-fibres.png" alt="Fabric Fibres" height="700px" /></p>

<p>You should see one <code class="language-plaintext highlighter-rouge">fibre</code> icon for each node in your Fabric. In this case the node <code class="language-plaintext highlighter-rouge">fabric-n9</code> is the <code class="language-plaintext highlighter-rouge">infrastructure</code> node (indicated by the cross in its icon). The <code class="language-plaintext highlighter-rouge">infrastructure</code> node is responsible for downloading artifacts and deploying them to other nodes.</p>

<h3 id="set-labels">Set Labels</h3>

<p>Labels are used to control deployment. You may remember that the UI <code class="language-plaintext highlighter-rouge">system.part</code> was configured with a <code class="language-plaintext highlighter-rouge">contract</code> so it would only be deployed to a fibre with the <code class="language-plaintext highlighter-rouge">UI</code> feature.</p>

<p>Click on the <code class="language-plaintext highlighter-rouge">Labels</code> tab so see whether the <code class="language-plaintext highlighter-rouge">UI</code> label is already set.</p>

<p>Then click back to the <code class="language-plaintext highlighter-rouge">Fabric</code> tab, and click the node where you want the UI to be deployed. For example, the <code class="language-plaintext highlighter-rouge">infrastructure</code> node <code class="language-plaintext highlighter-rouge">fabric-n9</code>.</p>

<p>Then enter “UI” for the name and “true” for the value, and click the <code class="language-plaintext highlighter-rouge">+</code> symbol:</p>

<p><img src="img/fabric-label.png" alt="Fabric Label" height="700px" /></p>

<p>Now return to the main view by clicking the fabric name in the bread crumbs at the top left (its <code class="language-plaintext highlighter-rouge">:: brain-iot ::</code> in this example).</p>

<h3 id="deploy-system">Deploy System</h3>

<p>Click the <code class="language-plaintext highlighter-rouge">Systems</code> tab, and then paste the URL of the Security Light <code class="language-plaintext highlighter-rouge">system document</code> we prepared earlier:</p>

<p><img src="img/fabric-import.png" alt="Fabric Import" height="700px" /></p>

<p>Then click the <code class="language-plaintext highlighter-rouge">Import</code> button, after a few seconds the system name should appear:</p>

<p><img src="img/fabric-import2.png" alt="Fabric Import 2" height="700px" /></p>

<p>Now click the system name and you’ll see the deployment page:</p>

<p><img src="img/fabric-import-valid.png" alt="Fabric Import Valid" height="700px" /></p>

<p class="warning">If the state is not <code class="language-plaintext highlighter-rouge">valid/managed</code> it means there was a problem resolving the bundles. See the <a href="35-fabric-onpremise.html#trouble-shooting">trouble shooting</a> page for how to diagnose this issue.</p>

<p>Click the <code class="language-plaintext highlighter-rouge">deploy</code> control (it looks like a play button). After a minute (or two) you should see the resolution of the deployment, showing the UI has been deployed to <code class="language-plaintext highlighter-rouge">fabric-n9</code> and the  BRAIN-IoT Core has been deployed to all other nodes:</p>

<p><img src="img/fabric-deploy.png" alt="Fabric Deploy" height="750px" /></p>

<h2 id="brain-iot-ui">BRAIN-IoT UI</h2>

<p>Now that the system has been deployed, we should be able to access the BRAIN-IoT UI on port <code class="language-plaintext highlighter-rouge">8888</code> of <code class="language-plaintext highlighter-rouge">fabric-n9</code> <a href="http://10.8.0.94:8888" target="_blank">http://10.8.0.94:8888</a></p>

<p>Login with username <code class="language-plaintext highlighter-rouge">admin</code> and password <code class="language-plaintext highlighter-rouge">admin</code> as in the <code class="language-plaintext highlighter-rouge">quickstart</code> tutorial.</p>

<p>Now click on the <code class="language-plaintext highlighter-rouge">Hosts</code> tab, you should see all the nodes in the BRAIN-IoT Fabric:</p>

<p><img src="img/ui-hosts.png" alt="UI Hosts" height="700px" /></p>

<p class="note">We didn’t visit this page in the <code class="language-plaintext highlighter-rouge">quickstart</code> tutorial because there was only a single host.</p>

<p>Now click the <code class="language-plaintext highlighter-rouge">Behaviours</code> tab and you’ll see the Security Light Behaviours are already there. This is because the <code class="language-plaintext highlighter-rouge">system document</code> configured the BMS with the Security Light Example index.</p>

<p>We will now install the Security Light Behaviours, each on a different node.</p>

<p>Click on <code class="language-plaintext highlighter-rouge">Example Smart Security Sensor</code> and then click in the <code class="language-plaintext highlighter-rouge">Install host</code> field (as we did in the <code class="language-plaintext highlighter-rouge">quickstart</code> tutorial), but now you can choose to install the behaviour on any host:</p>

<p><img src="img/ui-behaviours-install.png" alt="UI Behaviours Install" height="700px" /></p>

<p>Choose any host and click <code class="language-plaintext highlighter-rouge">Install</code>, then repeat for the <code class="language-plaintext highlighter-rouge">Example Smart Light Bulb</code> and <code class="language-plaintext highlighter-rouge">Example Smart Security Light Behaviour</code> choosing a different host each time.</p>

<p class="note">You may need to refresh the page or switch tabs to see the <code class="language-plaintext highlighter-rouge">Installed</code> icon change.</p>

<p>If you now click on the <code class="language-plaintext highlighter-rouge">Hosts</code> tab, you should see that 3 hosts have 1 behaviour installed:</p>

<p><img src="img/ui-hosts-2.png" alt="UI Hosts  2" height="700px" /></p>

<h2 id="security-light-example">Security Light Example</h2>

<p>You can now run throught the Security Light Example (as we did in the <code class="language-plaintext highlighter-rouge">quickstart</code> tutorial), except now the <code class="language-plaintext highlighter-rouge">sensor</code> and <code class="language-plaintext highlighter-rouge">light</code> are on different hosts.</p>

<p>The <code class="language-plaintext highlighter-rouge">sensor</code> was installed to <code class="language-plaintext highlighter-rouge">fabric-n1</code> and the <code class="language-plaintext highlighter-rouge">light</code> to <code class="language-plaintext highlighter-rouge">fabric-n4</code>.</p>

<p>So the URL for the <code class="language-plaintext highlighter-rouge">sensor</code> is <a href="http://10.8.0.22:9100/sensor-ui/index.html" target="_blank">http://10.8.0.22:9100/sensor-ui/index.html</a>, and the URL for the <code class="language-plaintext highlighter-rouge">light</code> is  <a href="http://10.8.0.66:9100/light-ui/index.html" target="_blank">http://10.8.0.66:9100/light-ui/index.html</a></p>

<p class="note">Note that these URLs are <em>not</em> prefixed by /example as they were in the <code class="language-plaintext highlighter-rouge">quickstart</code> tutorial and they use port 9100.</p>

<p>The example should work just as it did in the <code class="language-plaintext highlighter-rouge">quickstart</code> tutorial, except now the events are being delivered to remote nodes!</p>

<h3 id="discover-http-port">Discover HTTP port</h3>

<p>To see which port is used by the HTTP service for the example UIs, you need to look in Fabric Admin. Click the icon for the node, in this case <code class="language-plaintext highlighter-rouge">fabric-n1</code> and then click the <code class="language-plaintext highlighter-rouge">HTTP Runtime</code> tab. Click the <code class="language-plaintext highlighter-rouge">Framework</code> dropdown and select the <code class="language-plaintext highlighter-rouge">Core</code> framework.</p>

<p>The IP address and port are listed under <code class="language-plaintext highlighter-rouge">Serving Endpoint</code>:</p>

<p><img src="img/fabric-http-runtime.png" alt="Fabric HTTP Runtime" height="700px" /></p>

<h2 id="undeploy">Undeploy</h2>

<p>To remove the <code class="language-plaintext highlighter-rouge">system</code> from the Fabric, click on the <code class="language-plaintext highlighter-rouge">Systems</code> tab in Fabric Admin and then click the <code class="language-plaintext highlighter-rouge">Security Light</code> system.</p>

<p>Click the <code class="language-plaintext highlighter-rouge">remove</code> control (looks like an eject button) and the system will be removed.</p>

<h2 id="end">End</h2>

<p>That completes this tutorial.</p>



        </article>

      <!--</div>-->
        <hr />
        <a class=nav-prev href="10-developer.html" >Prev</a>
        <a class=nav-next href="30-fabric-cloud.html" >Next</a>

    </div>
</div>
</div>

        <!--/div-->
      </div>

      <footer class="site-footer">

<nav class=next-prev>
        <a href='/tutorial/10-developer.html'></a> <a href='/tutorial/30-fabric-cloud.html'></a>
</nav>

<script>
$(function() {
  return $("h2, h3, h4, h5, h6").each(function(i, el) {
    var $el, icon, id;
    $el = $(el);
    id = $el.attr('id');
    icon = '<i class="fa fa-link"></i>';
    if (id) {
      return $el.prepend($("<a />").addClass("header-link").attr("href", "#" + id).html(icon));
    }
  });
});
</script>

</footer>

    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!-- MathJax -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script type="text/javascript">
    $('body').scrollspy({
        target: '.bs-docs-sidebar',
        offset: 150 /* fixed header is about 40px high */
    });
    </script>

  </body>

</html>
